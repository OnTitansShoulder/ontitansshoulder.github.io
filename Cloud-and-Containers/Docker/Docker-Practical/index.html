<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="We are all standing on the shoulders of the giants..."><meta name=author content="Zhongkai Liu"><link rel="shortcut icon" href=../../../assets/favicon.ico><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.6"><title>Image Build & Optimization - Ontitansshoulder</title><link rel=stylesheet href=../../../assets/stylesheets/main.cb6bc1d0.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.39b8e14a.min.css><meta name=theme-color content=#4051b5><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../../../css/extra.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#optimizing-docker-images class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=../../.. title=Ontitansshoulder class="md-header-nav__button md-logo" aria-label=Ontitansshoulder> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <div class=md-header-nav__topic> <span class=md-ellipsis> Ontitansshoulder </span> </div> <div class=md-header-nav__topic> <span class=md-ellipsis> Image Build & Optimization </span> </div> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class="md-tabs__link md-tabs__link--active"> Notes </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=Ontitansshoulder class="md-nav__button md-logo" aria-label=Ontitansshoulder> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> Ontitansshoulder </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1 checked> <label class=md-nav__link for=nav-1> Notes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Notes data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Welcome </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2> <label class=md-nav__link for=nav-1-2> Foundamentals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Foundamentals data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"></span> Foundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Foundamental/Data_Structures_and_Algos/ class=md-nav__link> Data Structures and Algos </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <label class=md-nav__link for=nav-1-3> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3-1 type=checkbox id=nav-1-3-1> <label class=md-nav__link for=nav-1-3-1> Concepts <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Concepts data-md-level=3> <label class=md-nav__title for=nav-1-3-1> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Concepts/Linux_Foundation/ class=md-nav__link> Linux Foundation </a> </li> <li class=md-nav__item> <a href=../../../Linux/Concepts/Linux_Foundation_System_Admin/ class=md-nav__link> Linux System Administration </a> </li> <li class=md-nav__item> <a href=../../../Linux/Concepts/Linux_Foundation_Network_Admin/ class=md-nav__link> Linux Network Administration </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3-2 type=checkbox id=nav-1-3-2> <label class=md-nav__link for=nav-1-3-2> Practical References <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Practical References" data-md-level=3> <label class=md-nav__title for=nav-1-3-2> <span class="md-nav__icon md-icon"></span> Practical References </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Commands/Freq-Used-Shell-Cmds/ class=md-nav__link> Freq Used Shell Cmds </a> </li> <li class=md-nav__item> <a href=../../../Linux/Commands/Networking-Shell-Cmds/ class=md-nav__link> Freq Used Network Cmds </a> </li> <li class=md-nav__item> <a href=../../../Linux/Commands/Text-Manipulating-Cmds/ class=md-nav__link> Text Manipulating Cmds </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3-3 type=checkbox id=nav-1-3-3> <label class=md-nav__link for=nav-1-3-3> Tricks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Tricks data-md-level=3> <label class=md-nav__title for=nav-1-3-3> <span class="md-nav__icon md-icon"></span> Tricks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/References/Freq-Tasks/ class=md-nav__link> Freq Linux Tasks </a> </li> <li class=md-nav__item> <a href=../../../Linux/References/Terminal-Tricks/ class=md-nav__link> Linux Terminal Tricks </a> </li> <li class=md-nav__item> <a href=../../../Linux/References/Vim-Tricks/ class=md-nav__link> Vim Tricks </a> </li> <li class=md-nav__item> <a href=../../../Linux/References/Account-Administration/ class=md-nav__link> Manage Accounts & Groups </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4 type=checkbox id=nav-1-4 checked> <label class=md-nav__link for=nav-1-4> Cloud <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Cloud data-md-level=2> <label class=md-nav__title for=nav-1-4> <span class="md-nav__icon md-icon"></span> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Architecture/Cloud-App-Architecture/ class=md-nav__link> Cloud App Architecture </a> </li> <li class=md-nav__item> <a href=../Docker/ class=md-nav__link> Docker and Containers </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Docker Practical <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Docker Practical </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#optimizing-docker-images class=md-nav__link> Optimizing Docker Images </a> <nav class=md-nav aria-label="Optimizing Docker Images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reducing-deployment-time class=md-nav__link> Reducing deployment time </a> </li> <li class=md-nav__item> <a href=#improving-image-build-time class=md-nav__link> Improving image build time </a> </li> <li class=md-nav__item> <a href=#reducing-the-build-context-size class=md-nav__link> Reducing the build context size </a> </li> <li class=md-nav__item> <a href=#using-caching-proxies class=md-nav__link> Using caching proxies </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reducing-docker-image-size class=md-nav__link> Reducing Docker image size </a> <nav class=md-nav aria-label="Reducing Docker image size"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#avoid-unnecessary-packages class=md-nav__link> Avoid unnecessary packages </a> </li> <li class=md-nav__item> <a href=#chaining-commands class=md-nav__link> Chaining commands </a> </li> <li class=md-nav__item> <a href=#separating-build-and-deployment-images class=md-nav__link> Separating build and deployment images </a> <nav class=md-nav aria-label="Separating build and deployment images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multi-stage-image-build class=md-nav__link> Multi-stage image build </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-disk-usage-cleanup class=md-nav__link> Docker Disk Usage Cleanup </a> </li> <li class=md-nav__item> <a href=#frequently-used-docker-cli-commands-reference class=md-nav__link> Frequently-used Docker CLI commands reference </a> </li> <li class=md-nav__item> <a href=#dockerfile-reference class=md-nav__link> Dockerfile Reference </a> <nav class=md-nav aria-label="Dockerfile Reference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-a-docker-image-is-built class=md-nav__link> How a Docker image is built </a> <nav class=md-nav aria-label="How a Docker image is built"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#build-context class=md-nav__link> build context </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dockerfile-instructions class=md-nav__link> Dockerfile instructions </a> <nav class=md-nav aria-label="Dockerfile instructions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#from class=md-nav__link> FROM </a> </li> <li class=md-nav__item> <a href=#run class=md-nav__link> RUN </a> </li> <li class=md-nav__item> <a href=#cmd class=md-nav__link> CMD </a> </li> <li class=md-nav__item> <a href=#label class=md-nav__link> LABEL </a> </li> <li class=md-nav__item> <a href=#expose class=md-nav__link> EXPOSE </a> </li> <li class=md-nav__item> <a href=#env class=md-nav__link> ENV </a> </li> <li class=md-nav__item> <a href=#add class=md-nav__link> ADD </a> </li> <li class=md-nav__item> <a href=#copy class=md-nav__link> COPY </a> </li> <li class=md-nav__item> <a href=#entrypoint class=md-nav__link> ENTRYPOINT </a> </li> <li class=md-nav__item> <a href=#volume class=md-nav__link> VOLUME </a> </li> <li class=md-nav__item> <a href=#user class=md-nav__link> USER </a> </li> <li class=md-nav__item> <a href=#workdir class=md-nav__link> WORKDIR </a> </li> <li class=md-nav__item> <a href=#arg class=md-nav__link> ARG </a> </li> <li class=md-nav__item> <a href=#onbuild class=md-nav__link> ONBUILD </a> </li> <li class=md-nav__item> <a href=#stopsignal class=md-nav__link> STOPSIGNAL </a> </li> <li class=md-nav__item> <a href=#healthcheck class=md-nav__link> HEALTHCHECK </a> </li> <li class=md-nav__item> <a href=#shell class=md-nav__link> SHELL </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../k8s/K8s-Knowledge/ class=md-nav__link> K8s Knowledge </a> </li> <li class=md-nav__item> <a href=../../k8s/service_mesh/ class=md-nav__link> Service Mesh </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-5 type=checkbox id=nav-1-5> <label class=md-nav__link for=nav-1-5> Monitoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Monitoring data-md-level=2> <label class=md-nav__title for=nav-1-5> <span class="md-nav__icon md-icon"></span> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-5-1 type=checkbox id=nav-1-5-1> <label class=md-nav__link for=nav-1-5-1> Splunk <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Splunk data-md-level=3> <label class=md-nav__title for=nav-1-5-1> <span class="md-nav__icon md-icon"></span> Splunk </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Dev-Tools-Reference/Splunk/Splunk-References/ class=md-nav__link> Splunk Knowledge </a> </li> <li class=md-nav__item> <a href=../../../Dev-Tools-Reference/Splunk/Splunk-Dashboarding/ class=md-nav__link> Splunk Dashboarding </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-6 type=checkbox id=nav-1-6> <label class=md-nav__link for=nav-1-6> Programming Langs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Programming Langs" data-md-level=2> <label class=md-nav__title for=nav-1-6> <span class="md-nav__icon md-icon"></span> Programming Langs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-6-1 type=checkbox id=nav-1-6-1> <label class=md-nav__link for=nav-1-6-1> Golang <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Golang data-md-level=3> <label class=md-nav__title for=nav-1-6-1> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Golang/Golang-Specs/ class=md-nav__link> Golang Language Reference </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Golang/Best-Practices/ class=md-nav__link> Effective Go </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Golang/Freq-Used-Libs/ class=md-nav__link> Go libraries and examples </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-6-2 type=checkbox id=nav-1-6-2> <label class=md-nav__link for=nav-1-6-2> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=3> <label class=md-nav__title for=nav-1-6-2> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Java/Style-Guide/ class=md-nav__link> Style Guide </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Java/Best-Practices/ class=md-nav__link> Effective Java </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Java/Design-Patterns/ class=md-nav__link> Java Design Patterns </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Java/Testing-Design-Patterns/ class=md-nav__link> Testing Design Patterns </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Java/Java_Std_Lib_Cheatsheet/ class=md-nav__link> Java Std Lib Cheatsheet </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-6-3 type=checkbox id=nav-1-6-3> <label class=md-nav__link for=nav-1-6-3> C++ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=C++ data-md-level=3> <label class=md-nav__title for=nav-1-6-3> <span class="md-nav__icon md-icon"></span> C++ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/CPP/CPlusPlus_Lang_Specs/ class=md-nav__link> C++ Language Reference </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-6-4 type=checkbox id=nav-1-6-4> <label class=md-nav__link for=nav-1-6-4> Perl <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Perl data-md-level=3> <label class=md-nav__title for=nav-1-6-4> <span class="md-nav__icon md-icon"></span> Perl </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Perl/Perl-Lang-Specs/ class=md-nav__link> Perl Language Reference </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-6-5 type=checkbox id=nav-1-6-5> <label class=md-nav__link for=nav-1-6-5> Shell <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Shell data-md-level=3> <label class=md-nav__title for=nav-1-6-5> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Shell/Shell-Scripting/ class=md-nav__link> Shell Scripting </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Github-Markdown/ class=md-nav__link> Github Markdown Guide </a> </li> <li class=md-nav__item> <a href=../../../Programming-Lang-Reference/Regex-Specs/ class=md-nav__link> Regex Cheatsheet </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-7 type=checkbox id=nav-1-7> <label class=md-nav__link for=nav-1-7> Reading Notes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Reading Notes" data-md-level=2> <label class=md-nav__title for=nav-1-7> <span class="md-nav__icon md-icon"></span> Reading Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Reading-Notes/How-Netflix-Works/ class=md-nav__link> How Netflix Works </a> </li> <li class=md-nav__item> <a href=../../../Reading-Notes/System-Design-Concepts/ class=md-nav__link> System Design Guide </a> </li> <li class=md-nav__item> <a href=../../../Reading-Notes/Why-Latency-Matters/ class=md-nav__link> Why Latency Matters </a> </li> <li class=md-nav__item> <a href=../../../Reading-Notes/DevOps_SRE/ class=md-nav__link> Intro to DevOps and SRE </a> </li> <li class=md-nav__item> <a href=../../../Reading-Notes/Leading-without-formal-authority/ class=md-nav__link> Leading Without Formal Authority </a> </li> <li class=md-nav__item> <a href=../../../Reading-Notes/Google-SRE-Book/ class=md-nav__link> Google SRE Book </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../Good-Reads/ class=md-nav__link> Good Reads </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#optimizing-docker-images class=md-nav__link> Optimizing Docker Images </a> <nav class=md-nav aria-label="Optimizing Docker Images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reducing-deployment-time class=md-nav__link> Reducing deployment time </a> </li> <li class=md-nav__item> <a href=#improving-image-build-time class=md-nav__link> Improving image build time </a> </li> <li class=md-nav__item> <a href=#reducing-the-build-context-size class=md-nav__link> Reducing the build context size </a> </li> <li class=md-nav__item> <a href=#using-caching-proxies class=md-nav__link> Using caching proxies </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reducing-docker-image-size class=md-nav__link> Reducing Docker image size </a> <nav class=md-nav aria-label="Reducing Docker image size"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#avoid-unnecessary-packages class=md-nav__link> Avoid unnecessary packages </a> </li> <li class=md-nav__item> <a href=#chaining-commands class=md-nav__link> Chaining commands </a> </li> <li class=md-nav__item> <a href=#separating-build-and-deployment-images class=md-nav__link> Separating build and deployment images </a> <nav class=md-nav aria-label="Separating build and deployment images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multi-stage-image-build class=md-nav__link> Multi-stage image build </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-disk-usage-cleanup class=md-nav__link> Docker Disk Usage Cleanup </a> </li> <li class=md-nav__item> <a href=#frequently-used-docker-cli-commands-reference class=md-nav__link> Frequently-used Docker CLI commands reference </a> </li> <li class=md-nav__item> <a href=#dockerfile-reference class=md-nav__link> Dockerfile Reference </a> <nav class=md-nav aria-label="Dockerfile Reference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-a-docker-image-is-built class=md-nav__link> How a Docker image is built </a> <nav class=md-nav aria-label="How a Docker image is built"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#build-context class=md-nav__link> build context </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dockerfile-instructions class=md-nav__link> Dockerfile instructions </a> <nav class=md-nav aria-label="Dockerfile instructions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#from class=md-nav__link> FROM </a> </li> <li class=md-nav__item> <a href=#run class=md-nav__link> RUN </a> </li> <li class=md-nav__item> <a href=#cmd class=md-nav__link> CMD </a> </li> <li class=md-nav__item> <a href=#label class=md-nav__link> LABEL </a> </li> <li class=md-nav__item> <a href=#expose class=md-nav__link> EXPOSE </a> </li> <li class=md-nav__item> <a href=#env class=md-nav__link> ENV </a> </li> <li class=md-nav__item> <a href=#add class=md-nav__link> ADD </a> </li> <li class=md-nav__item> <a href=#copy class=md-nav__link> COPY </a> </li> <li class=md-nav__item> <a href=#entrypoint class=md-nav__link> ENTRYPOINT </a> </li> <li class=md-nav__item> <a href=#volume class=md-nav__link> VOLUME </a> </li> <li class=md-nav__item> <a href=#user class=md-nav__link> USER </a> </li> <li class=md-nav__item> <a href=#workdir class=md-nav__link> WORKDIR </a> </li> <li class=md-nav__item> <a href=#arg class=md-nav__link> ARG </a> </li> <li class=md-nav__item> <a href=#onbuild class=md-nav__link> ONBUILD </a> </li> <li class=md-nav__item> <a href=#stopsignal class=md-nav__link> STOPSIGNAL </a> </li> <li class=md-nav__item> <a href=#healthcheck class=md-nav__link> HEALTHCHECK </a> </li> <li class=md-nav__item> <a href=#shell class=md-nav__link> SHELL </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Docker Practical</h1> <p>This set of notes is taken from the book <em>Docker High Performance</em> by Allan Espinosa, Russ McKendrick and from the official <a href=https://docs.docker.com>Docker documentation</a>.</p> <p><br></p> <h2 id=optimizing-docker-images>Optimizing Docker Images<a class=headerlink href=#optimizing-docker-images title="Permanent link">&para;</a></h2> <p>As you keep building and iterating a Docker image, eventually the small container and fast build time goes away when a docker image becomes huge in the order of gigabytes. Then it is worth a while to seek ways to optimize the image building process.</p> <h3 id=reducing-deployment-time>Reducing deployment time<a class=headerlink href=#reducing-deployment-time title="Permanent link">&para;</a></h3> <p>If deployments happen within your network, consider a <strong>local registry</strong>.</p> <p>By setting up a local registry, it saves time and bandwidth when distributing Docker images without relying on external hubs.</p> <div class=highlight><pre><span></span><code><span class=c1># will set a local registry running at tcp://dockerhost:5000</span>
docker run --network<span class=o>=</span>host -d registry:2
docker tag someimage dockerhost:5000/someimage
docker push dockerhost:5000/someimage
docker pull dockerhost:5000/someimage
</code></pre></div> <p>More details on setting up a managed Docker registry https://docs.docker.com/registry/deploying</p> <h3 id=improving-image-build-time>Improving image build time<a class=headerlink href=#improving-image-build-time title="Permanent link">&para;</a></h3> <p>Using <strong>registry mirrors</strong> saves time when fetching upstream images.</p> <p>If the <code>FROM &lt;image&gt;</code> is quite large, definitely consider using a <strong>local registry mirror</strong> to speed up the fetch within local network.</p> <p>In this way, a large image will be fetched <strong>only once</strong> into the mirror and distributed fast within local network.</p> <p>After a managed local registry mirror is set, add the registry mirror host or ip address to the Docker daemon by updating <code>/etc/docker/daemon.json</code> and add into <code>registry-mirrors</code> and restart the docker service: <code>systemctl restart docker.service</code></p> <div class=highlight><pre><span></span><code><span class=p>{</span>
  <span class=nt>&quot;registry-mirrors&quot;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&quot;http://127.0.0.1:5000&quot;</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></div> <p>Read more https://docs.docker.com/registry/recipes/mirror/</p> <p><strong>Reusing image layers</strong> helps speed up the image build process, as a Docker image consists of a series of <strong>layers</strong> combined with the <em>union filesystem</em> of a single image, and reused image layers won't need to be build or fetched again.</p> <p>How Dockerfile instructions are cached https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#leverage-build-cache</p> <p>Group the tasks of things that won't expect to change often, i.e. dependency installation, and do them early in the Dockerfile will help reuse those layers.</p> <p>For example, copy a <em>dependency file</em> and run the installation command before copy the <em>source files</em> into the image, since the source files are expected to <strong>change more often</strong>.</p> <h3 id=reducing-the-build-context-size>Reducing the build context size<a class=headerlink href=#reducing-the-build-context-size title="Permanent link">&para;</a></h3> <p>Try to <strong>avoid copy unnecessary files</strong> into the image.</p> <p>Use <strong><code>.dockerignore</code></strong> file in the same directory as the Dockerfile to omit some kind of directories or files from being copied into the image.</p> <p>More on <code>.dockerignore</code> https://docs.docker.com/reference/builder/#dockerignore-file</p> <p><strong>Omitting the build context</strong> can be useful in situations where your <code>Dockerfile</code> does NOT require files to be copied into the image, and improves the build-speed, as no files are sent to the daemon. It can be done by passing the build context through <strong>STDIN</strong></p> <div class=highlight><pre><span></span><code>docker build -t myimage:latest -<span class=s>&lt;&lt;EOF</span>
<span class=s>FROM busybox</span>
<span class=s>RUN echo &quot;hello world&quot;</span>
<span class=s>EOF</span>
docker build <span class=o>[</span>OPTIONS<span class=o>]</span> -f- CONTEXT_PATH <span class=c1># read Dockerfile from STDIN</span>
</code></pre></div> <h3 id=using-caching-proxies>Using caching proxies<a class=headerlink href=#using-caching-proxies title="Permanent link">&para;</a></h3> <p>Another common problem that causes long runtimes in building Docker images is <strong>instructions that download dependencies</strong>, such as fetching packages from <code>yum</code> repositories or python modules.</p> <p>A useful technique to reduce the time for these build instructions is to introduce <strong>proxies</strong> that cache such dependency packages, such as</p> <ul> <li><em>apt-cacher-ng</em>: supports caching <em>Debian</em>, <em>RPM</em>, and other distribution-specific packages<ul> <li>https://www.unix-ag.uni-kl.de/~bloch/acng</li> </ul> </li> <li><em>Sonatype Nexus</em>: supports <em>Maven</em>, <em>Ruby Gems</em>, <em>PyPI</em>, and <em>NuGet</em> packages out of the box<ul> <li>http://www.sonatype.org/nexus</li> </ul> </li> <li><em>Polipo</em>: a generic caching proxy that is useful for development<ul> <li>http://www.pps.univ-paris-diderot.fr/~jch/software/polipo</li> </ul> </li> <li><em>Squid</em>: another popular caching proxy that can work with other types of network traffic<ul> <li>http://www.squid-cache.org/</li> </ul> </li> </ul> <p>This technique is useful when we develop <strong>base</strong> Docker images for our team or organization.</p> <blockquote> <p>In general, it is recommended that we verify the contents of public Docker images in environments, such as Docker Hub, instead of blindly trusting them.</p> </blockquote> <p><br></p> <h2 id=reducing-docker-image-size>Reducing Docker image size<a class=headerlink href=#reducing-docker-image-size title="Permanent link">&para;</a></h2> <p>While the increase of the image size is inevitable as more changes and features added to the program being containerized, there are some good practices to help <em>reduce the image size</em> or <em>speed up the build</em>.</p> <h3 id=avoid-unnecessary-packages>Avoid unnecessary packages<a class=headerlink href=#avoid-unnecessary-packages title="Permanent link">&para;</a></h3> <p>Avoid installing extra or unnecessary packages just because they might be "nice to have."</p> <p>Docker images grow big because some instructions are added that are unnecessary to build or run an image.</p> <p><strong>Limiting each container to one process</strong> is a good rule of thumb, but it is not a hard and fast rule. Use your best judgment to keep containers as clean and modular as possible.</p> <h3 id=chaining-commands>Chaining commands<a class=headerlink href=#chaining-commands title="Permanent link">&para;</a></h3> <p>Packaging <strong>metadata and cache</strong> are the common parts of the code that are usually increased in size. A Docker image's size is basically the <strong>sum of each individual layer image</strong> (more specifically, only <code>RUN COPY ADD</code> creates layers, other instructions creates temporary intermediate layers that won't add up image size); this is how <strong>union filesystems</strong> work. That's why installing packages and removing cache in a separate step will not reduce the image size, like following practice:</p> <div class=highlight><pre><span></span><code>FROM debian:stretch

RUN <span class=nb>echo</span> deb http://httpredir.debian.org/debian stretch-backports main <span class=se>\</span>
    &gt; /etc/apt/sources.list.d/stretch-backports.list
RUN apt-get update
RUN apt-get --no-install-recommends install -y openjdk-11-jre-headless
RUN rm -rfv /var/lib/apt/lists/* <span class=c1># won&#39;t reduce the final image size</span>
</code></pre></div> <p>There is no such thing as <em>negative layer size</em>, and so each instruction in a Dockerfile can only keep the image size <strong>constant</strong> or <strong>increase</strong> it. Instead, the <strong>cleaning</strong> steps should be performed in the <strong>same image layer as where those changes were introduced</strong>.</p> <p>Docker uses <code>/bin/sh</code> to run each instruction given to <code>RUN</code>, so can use <strong><code>&amp;&amp;</code></strong> to <strong>chain commands</strong>. Alternatively, (when there are many instructions) put the commands in a <strong>shell script</strong>, copy the script in and run the script.</p> <p>Whenever possible, ease later changes by <strong>sorting multi-line arguments</strong> alphanumerically. This helps to avoid duplication of packages and make the list much easier to update.</p> <div class=highlight><pre><span></span><code>FROM debian:stretch

RUN <span class=nb>echo</span> deb http://httpredir.debian.org/debian stretch-backports main <span class=se>\</span>
    &gt; /etc/apt/sources.list.d/stretch-backports.list <span class=o>&amp;&amp;</span> <span class=se>\</span>
    apt-get update <span class=o>&amp;&amp;</span> <span class=se>\</span>
    apt-get --no-install-recommends install -y openjdk-11-jre-headless <span class=o>&amp;&amp;</span> <span class=se>\</span>
    rm -rfv /var/lib/apt/lists/*
</code></pre></div> <h3 id=separating-build-and-deployment-images>Separating build and deployment images<a class=headerlink href=#separating-build-and-deployment-images title="Permanent link">&para;</a></h3> <p><strong>Source libraries</strong>, such as compilers and source header files, are only necessary when <strong>building an application</strong> inside a Docker image. After the application is built, only the compiled binary and related shared libraries are needed to run the application.</p> <p>For example, use an image with <code>jdk</code> installed to build <strong>jar</strong> files then use an image with <code>jvm</code> to run the jars; use an image with <code>golang</code> installed to build the <strong>binary</strong> from go source and use a small Linux base-image (better, <code>alpine</code> or <code>busybox</code>) to run the binary.</p> <p>This build is bad, as the image is used to build the app and also run the app. The go compilers and static libraries for the build are unnecessary when running the app.</p> <div class=highlight><pre><span></span><code>FROM golang:1.11-stretch

ADD hello.go
RUN go build hello.go
EXPOSE <span class=m>8080</span>
ENTRYPOINT <span class=o>[</span><span class=s2>&quot;./hello&quot;</span><span class=o>]</span>
</code></pre></div> <h4 id=multi-stage-image-build>Multi-stage image build<a class=headerlink href=#multi-stage-image-build title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=c1># this base-image serve as a build stage for the final image</span>
FROM golang:1.11-stretch

ADD hello.go hello.go
RUN go build hello.go

<span class=c1># Good to have a base image that has some debugging tools</span>
FROM busybox

COPY --from<span class=o>=</span><span class=m>0</span> /go/hello /app/hello
<span class=c1># The libraries are obtained from running `ldd hello` which prints shared object dependencies on the binary</span>
COPY --from<span class=o>=</span><span class=m>0</span> /lib/x86_64-linux-gnu/libpthread.so.0 <span class=se>\</span>
                    /lib/x86_64-linux-gnu/libpthread.so.0
COPY --from<span class=o>=</span><span class=m>0</span> /lib/x86_64-linux-gnu/libc.so.6 /lib/x86_64-linux-gnu/libc.so.6
COPY --from<span class=o>=</span><span class=m>0</span> /lib64/ld-linux-x86-64.so.2 /lib64/ld-linux-x86-64.so.2
WORKDIR /app
EXPOSE <span class=m>8080</span>
ENTRYPOINT <span class=o>[</span><span class=s2>&quot;./hello&quot;</span><span class=o>]</span>
</code></pre></div> <p><strong>Multi-stage</strong> builds allow you to drastically reduce the size of your final image, without struggling to reduce the number of intermediate layers and files.</p> <ul> <li>the image is built during the final stage of the build process, you can minimize image layers by leveraging <strong>build cache</strong></li> <li><strong>order the instructions</strong> from the less frequently changed to the more frequently changed to ensure the build cache is reusable<ul> <li>install tools for building the app</li> <li>install or update library dependencies</li> <li>generate the app</li> </ul> </li> </ul> <div class=highlight><pre><span></span><code>FROM golang:1.11-alpine AS build

<span class=c1># Install tools required for project</span>
<span class=c1># Run `docker build --no-cache .` to update dependencies</span>
RUN apk add --no-cache git
RUN go get github.com/golang/dep/cmd/dep

<span class=c1># List project dependencies with Gopkg.toml and Gopkg.lock</span>
<span class=c1># These layers are only re-built when Gopkg files are updated</span>
COPY Gopkg.lock Gopkg.toml /go/src/project/
WORKDIR /go/src/project/
<span class=c1># Install library dependencies</span>
RUN dep ensure -vendor-only

<span class=c1># Copy the entire project and build it</span>
<span class=c1># This layer is rebuilt when a file changes in the project directory</span>
COPY . /go/src/project/
RUN go build -o /bin/project

<span class=c1># This results in a single layer image</span>
FROM scratch
COPY --from<span class=o>=</span>build /bin/project /bin/project
ENTRYPOINT <span class=o>[</span><span class=s2>&quot;/bin/project&quot;</span><span class=o>]</span>
CMD <span class=o>[</span><span class=s2>&quot;--help&quot;</span><span class=o>]</span>
</code></pre></div> <p><br></p> <h2 id=docker-disk-usage-cleanup>Docker Disk Usage Cleanup<a class=headerlink href=#docker-disk-usage-cleanup title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><span class=c1># prunes stopped containers, unused networks, dangling images, volumes, and cache</span>
docker system prune --all
docker system prune
docker system prune --volumes

<span class=c1># clean up specific component</span>
docker rmi <span class=k>$(</span>docker images -qf <span class=nv>dangling</span><span class=o>=</span><span class=nb>true</span><span class=k>)</span>
docker rmi <span class=k>$(</span>docker images <span class=p>|</span> grep &lt;image-name&gt; <span class=p>|</span> awk <span class=s1>&#39;{print $3}&#39;</span><span class=k>)</span>
docker volume rm <span class=k>$(</span>docker volume ls -qf <span class=nv>dangling</span><span class=o>=</span><span class=nb>true</span><span class=k>)</span>
</code></pre></div> <h2 id=frequently-used-docker-cli-commands-reference>Frequently-used Docker CLI commands reference<a class=headerlink href=#frequently-used-docker-cli-commands-reference title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code>docker info <span class=c1># prints a summary of current docker environment</span>
docker <span class=nb>help</span> <span class=c1># see a list of docker commands</span>
docker pull &lt;image&gt; <span class=c1># pull down an image</span>
docker images <span class=c1># list local cached docker images</span>
docker run &lt;image&gt; <span class=c1># run a container</span>
docker ps <span class=c1># see running containers</span>
docker <span class=nb>kill</span> &lt;container_id&gt;.. <span class=c1># stop containers</span>
docker rm &lt;container_id&gt;.. <span class=c1># remove containers</span>
docker rmi &lt;image&gt;.. <span class=c1># remove docker images</span>
docker build -t &lt;image&gt;:&lt;tag&gt; .  <span class=c1># create image using current directory&#39;s Dockerfile</span>

<span class=c1># handy operations</span>
docker rmi <span class=k>$(</span>docker images -f <span class=s2>&quot;dangling=true&quot;</span> -q<span class=k>)</span> <span class=c1># remove dangling images</span>
docker run -p <span class=m>4000</span>:80 nginx <span class=c1># run a container mapping internal port 4000 to external port 80</span>
docker run -d helloworld <span class=c1># run a container detached (in background)</span>
</code></pre></div> <p><br></p> <h2 id=dockerfile-reference>Dockerfile Reference<a class=headerlink href=#dockerfile-reference title="Permanent link">&para;</a></h2> <h3 id=how-a-docker-image-is-built>How a Docker image is built<a class=headerlink href=#how-a-docker-image-is-built title="Permanent link">&para;</a></h3> <p>A <code>Dockerfile</code> is a text document that describes how a Docker image is built.</p> <p>The <code>docker build</code> command builds an image from a <code>Dockerfile</code> and a <strong>context</strong>.</p> <h4 id=build-context>build context<a class=headerlink href=#build-context title="Permanent link">&para;</a></h4> <p>The build's <strong>context</strong> is the set of files at a specified <em>location</em>, <em>PATH</em>, or <em>URL</em>. The PATH is a directory on your <em>local filesystem</em>. The URL is a <em>Git repository</em> location.</p> <p>The build is run by the <strong>Docker daemon</strong>, not by the <code>docker</code> CLI. The first thing a build process does is send the entire context (<strong>recursively</strong>) to the daemon.</p> <p>It's best to start with an empty directory as context and keep your <code>Dockerfile</code> in that directory. Add only the files needed for building the <code>Dockerfile</code>. Exclude files and directories by adding a <code>.dockerignore</code> file.</p> <p>By convention a <code>Dockerfile</code> is located in the root of the build context. </p> <ul> <li>use the <code>-f &lt;path&gt;</code> flag with <code>docker build</code> to point to a <code>Dockerfile</code> <em>anywhere</em> in your file system.</li> <li>specify a repository and tag at where to save the new image if the build succeeds, with <code>-t &lt;tag&gt;</code><ul> <li>multiple <code>-t</code> can be used</li> </ul> </li> <li>each instruction is run <strong>independently</strong>, and causes a new image (layer) to be created</li> <li>whenever possible, Docker will re-use the intermediate images (cache) to accelerate the build process</li> </ul> <p><strong>Build cache</strong> is only used from images that have a <strong>local parent chain</strong>.</p> <ul> <li>this means that these images were created by previous builds or the whole chain of images was loaded with <code>docker load</code>.</li> <li>images specified with <code>docker build --cache-from &lt;image&gt;</code> do not need to have a parent chain and may be pulled from other registries.</li> <li>once a layer is invalidated by the cache, all subsequent instructions generate new layers</li> </ul> <p>Starting with version <em>18.09</em>, Docker supports a new backend for executing your builds, the <code>BuildKit</code> which can be enabled by setting an environment variable <code>DOCKER_BUILDKIT=1</code> before building an image. The BuildKit backend provides many benefits compared to the old implementation.</p> <p>Learning about <a href=https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md>BuildKit</a> for new features</p> <h3 id=dockerfile-instructions>Dockerfile instructions<a class=headerlink href=#dockerfile-instructions title="Permanent link">&para;</a></h3> <h4 id=from>FROM<a class=headerlink href=#from title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>FROM <span class=o>[</span>--platform<span class=o>=</span>&lt;platform&gt;<span class=o>]</span> &lt;image&gt; <span class=o>[</span>AS &lt;name&gt;<span class=o>]</span>
FROM <span class=o>[</span>--platform<span class=o>=</span>&lt;platform&gt;<span class=o>]</span> &lt;image&gt;<span class=o>[</span>:&lt;tag&gt;<span class=o>]</span> <span class=o>[</span>AS &lt;name&gt;<span class=o>]</span>
FROM <span class=o>[</span>--platform<span class=o>=</span>&lt;platform&gt;<span class=o>]</span> &lt;image&gt;<span class=o>[</span>@&lt;digest&gt;<span class=o>]</span> <span class=o>[</span>AS &lt;name&gt;<span class=o>]</span>

<span class=c1># example</span>
ARG <span class=nv>VERSION</span><span class=o>=</span>latest
FROM busybox:<span class=nv>$VERSION</span>
ARG VERSION
RUN <span class=nb>echo</span> <span class=nv>$VERSION</span> &gt; image_version

FROM extras:<span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span>
CMD  /code/run-extras
</code></pre></div> </details> <p><strong><code>FROM</code></strong> initializes a new build stage and sets the Base Image for subsequent instructions.</p> <ul> <li>can appear multiple times within a single <code>Dockerfile</code> to create multiple images or use one build stage as a <em>dependency</em> for another</li> <li>a valid <code>Dockerfile</code> must start with a <code>FROM</code> instruction</li> <li><code>--platform</code> flag can be used to specify the platform of the image in case <code>FROM</code> references a multi-platform image, i.e. <code>linux/amd64</code></li> <li>a name can be given to a new build stage by adding <code>AS &lt;name&gt;</code> and used in <code>COPY --from=&lt;name|index&gt;</code></li> <li><code>tag</code> or <code>digest</code> values are optional, default use <code>latest</code> tag</li> <li><code>FROM</code> instructions support <strong>variables</strong> that are declared by any <code>ARG</code> instructions that occur before the <em>first</em> <code>FROM</code><ul> <li>An <code>ARG</code> declared before a <code>FROM</code> is outside of a <em>build stage</em>, so it can’t be used in any instruction after a <code>FROM</code>.</li> <li>To use the default value of an <code>ARG</code> declared before the first <code>FROM</code> use an <code>ARG</code> instruction without a value inside a build stage</li> </ul> </li> <li><strong>Tip</strong> use <code>alpine</code> as the baseimage whenever you can</li> </ul> <h4 id=run>RUN<a class=headerlink href=#run title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code><span class=c1># Following both are valid</span>
RUN /bin/bash -c <span class=s1>&#39;source $HOME/.bashrc; \</span>
<span class=s1>                  echo $HOME&#39;</span>
RUN <span class=o>[</span><span class=s2>&quot;/bin/bash&quot;</span>, <span class=s2>&quot;-c&quot;</span>, <span class=s2>&quot;echo hello&quot;</span><span class=o>]</span>
</code></pre></div> </details> <p><strong><code>RUN</code></strong> instruction will execute any commands in a <em>new layer</em> on top of the current image and commit the results; the committed image will be used for the next step/instruction</p> <ul> <li>Docker commits are cheap and containers can be created from any point in an image's history, much like source control.</li> <li>the cache for a <code>RUN</code> will be reused during the next build.<ul> <li>the cache can be invalidated by using the <code>docker build --no-cache</code> flag</li> <li>the cache for <code>RUN</code> instructions can be invalidated by <code>ADD</code> and <code>COPY</code> instructions</li> </ul> </li> <li>two forms of <code>RUN</code> instruction<ul> <li><code>RUN &lt;command/script&gt;</code> is called the <em>shell form</em><ul> <li>implicitly invoking <code>/bin/sh -c</code> on the command passed in</li> <li>can do variable substitution</li> </ul> </li> <li><code>RUN ["executable", "param1", "param2"]</code> is called the <em>exec form</em><ul> <li>pass the <em>executable</em> with full path</li> <li>does NOT invoke a command shell, NO <em>variable substitution</em>, more like to concatenate the array into a string command</li> <li>must use <strong>double quotes</strong> as it is parsed as JSON array</li> <li>can run commands using a different shell executable</li> <li>necessary to escape backslashes</li> </ul> </li> </ul> </li> <li><strong>Tip</strong><ul> <li>split long or complex <code>RUN</code> statements on multiple lines separated with <code>backslashes</code> to make your <code>Dockerfile</code> more readable, understandable, and maintainable. Or better: put them in a script</li> <li>always combine <em>update</em> and <em>install</em> statements in the same <code>RUN</code> instruction, as well as steps to clean up the <em>installation cache</em></li> <li>Using <code>RUN apt-get update &amp;&amp; apt-get install -y</code> ensures your <code>Dockerfile</code> installs the <em>latest</em> package versions with no further coding or manual intervention. This technique is known as <em>cache busting</em>. You can also achieve cache-busting by specifying a package version. This is known as <em>version pinning</em>.</li> <li>if using pipes, prepend <code>set -o pipefail &amp;&amp;</code> to ensure that an unexpected error prevents the build from inadvertently succeeding</li> </ul> </li> </ul> <h4 id=cmd>CMD<a class=headerlink href=#cmd title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>CMD <span class=o>[</span><span class=s2>&quot;/usr/bin/wc&quot;</span>,<span class=s2>&quot;--help&quot;</span><span class=o>]</span>
CMD <span class=nb>echo</span> <span class=s2>&quot;This is a test.&quot;</span> <span class=p>|</span> wc -
</code></pre></div> </details> <p><strong><code>CMD</code></strong> instruction provides defaults for an executing container.</p> <ul> <li>there can only be one <code>CMD</code> instruction in a <code>Dockerfile</code>, otherwise, only the last <code>CMD</code> will be used</li> <li>if <code>CMD</code> is used to provide default arguments for the <code>ENTRYPOINT</code>, then both of them should be specified with the JSON array format</li> <li>three forms of <code>CMD</code> instruction<ul> <li><code>CMD ["executable", "param1", "param2"]</code> is called the <strong>exec form</strong>, and is preferred form<ul> <li>pass the <em>executable</em> with full path</li> <li>does NOT invoke a command shell, NO <em>variable substitution</em>, more like to concatenate the array into a string command</li> <li>must use <strong>double quotes</strong> as it is parsed as JSON array</li> </ul> </li> <li><code>CMD ["param1","param2"]</code> provides default parameters to <code>ENTRYPOINT</code> which is necessary to be present</li> <li><code>CMD command param1 param2</code> is called the <strong>shell form</strong><ul> <li>implicitly invoking <code>/bin/sh -c</code> on the command passed in</li> </ul> </li> </ul> </li> </ul> <h4 id=label>LABEL<a class=headerlink href=#label title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>LABEL multi.label1<span class=o>=</span><span class=s2>&quot;value1&quot;</span> multi.label2<span class=o>=</span><span class=s2>&quot;value2&quot;</span> <span class=nv>other</span><span class=o>=</span><span class=s2>&quot;value3&quot;</span>
</code></pre></div> </details> <p><strong><code>LABEL</code></strong> instruction adds metadata to an image.</p> <ul> <li>it is a <em>key-value pair</em>, multiple can be specified on the same instruction, separated with <em>spaces</em></li> <li>key can contain periods and dashes</li> <li>use <em>double quotes</em> to include spaces in the value or a <em>backslash</em> to span string to multiple lines</li> <li>Labels included in base or parent images are inherited</li> <li>use <code>docker image inspect --format='' &lt;image&gt;</code> to see just the labels</li> </ul> <h4 id=expose>EXPOSE<a class=headerlink href=#expose title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>EXPOSE &lt;port&gt; <span class=o>[</span>&lt;port&gt;/&lt;protocol&gt;...<span class=o>]</span>
</code></pre></div> </details> <p><strong><code>EXPOSE</code></strong> instruction informs Docker that the container listens on the specified network ports at runtime.</p> <ul> <li>specify whether the port listens on TCP or UDP, default is TCP</li> <li>it does not actually publish the port but to serve as a <strong>documentation</strong> to tell the user which ports are intended to be published</li> <li>to actually map and publish the port when running the container, use <code>docker run -p &lt;internal-port&gt;:&lt;external-port&gt; &lt;image&gt;</code><ul> <li>this method takes precedence than what is specified in the <code>Dockerfile</code></li> </ul> </li> <li>use <code>docker run -P &lt;image&gt;</code> to publish all exposed ports and map to high-order ports i.e. <code>80:80</code></li> </ul> <h4 id=env>ENV<a class=headerlink href=#env title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>ENV &lt;key&gt; &lt;value&gt;
ENV &lt;key&gt;<span class=o>=</span>&lt;value&gt; ...
ENV <span class=nv>myName</span><span class=o>=</span><span class=s2>&quot;John Doe&quot;</span> <span class=nv>myDog</span><span class=o>=</span>Rex<span class=se>\ </span>The<span class=se>\ </span>Dog <span class=se>\</span>
    <span class=nv>myCat</span><span class=o>=</span>fluffy
ENV myDog Rex The Dog
</code></pre></div> </details> <p><strong><code>ENV</code></strong> instruction sets the environment variable <code>&lt;key&gt;</code> to the value <code>&lt;value&gt;</code></p> <ul> <li>this value will be in the environment for all <strong>subsequent instructions</strong> in the <strong>build stage</strong></li> <li>to set a value for a <strong>single command</strong>, use <code>RUN &lt;key&gt;=&lt;value&gt; &lt;command&gt;</code> (<code>RUN</code>'s shell form)</li> <li>environment variables set will <strong>persist</strong> when a container is run from the resulting image</li> <li>can view the environment variables values using <code>docker inspect</code> on an image</li> <li>environment variables can also be set when running <code>docker run --env &lt;key&gt;=&lt;value&gt;</code></li> <li><strong>variable expansion</strong> is supported by <code>ADD COPY ENV EXPOSE FROM LABEL STOPSIGNAL USER VOLUME WORKDIR ONBUILD</code></li> <li>two forms:<ul> <li><code>ENV &lt;key&gt; &lt;value&gt;</code> sets a single variable to a value<ul> <li>entire string after the first space will be treated as the value</li> </ul> </li> <li><code>ENV &lt;key&gt;=&lt;value&gt; ...</code> sets multiple variables to be set at one time</li> </ul> </li> <li><strong>Tip</strong> if you don't want to have an ENV var persist to the container, use the <strong>define, use, unset</strong> approach in a single instruction</li> </ul> <h4 id=add>ADD<a class=headerlink href=#add title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>ADD <span class=o>[</span>--chown<span class=o>=</span>&lt;user&gt;:&lt;group&gt;<span class=o>]</span> &lt;src&gt;... &lt;dest&gt;
ADD <span class=o>[</span>--chown<span class=o>=</span>&lt;user&gt;:&lt;group&gt;<span class=o>]</span> <span class=o>[</span><span class=s2>&quot;&lt;src&gt;&quot;</span>,... <span class=s2>&quot;&lt;dest&gt;&quot;</span><span class=o>]</span>
</code></pre></div> </details> <p><strong><code>ADD</code></strong> instruction copies <strong>new files</strong>, <strong>directories</strong> or <strong>remote file URLs</strong> from <code>&lt;src&gt;</code> and adds them to the filesystem of the image at the path <code>&lt;dest&gt;</code></p> <ul> <li><code>--chown</code> is for building on Linux system only<ul> <li>new files and directories are created with a <code>UID and GID of 0</code>, unless specified otherwise</li> <li>providing a username without groupname or a UID without GID will use the <em>same</em> numeric UID as the GID</li> </ul> </li> <li>source paths are interpreted as <strong>relative</strong> to the <strong>source of the context</strong> of the build</li> <li>CANNOT use <code>..</code> to leave the context directory</li> <li>source paths can contain <strong>wildcards</strong></li> <li>if source path is a <strong>directory</strong>, the <strong>entire contents</strong> of the directory are copied, including filesystem metadata</li> <li>if source path is an <code>URL</code> and destination path does NOT end with a <em>backslash</em>, then the file is downloaded as the <strong>destination path</strong>; otherwise, the filename is inferred from the URL and saved in the destination path directory</li> <li>if source path is a <strong>local compressed tarball archive</strong>, it is <strong>unpacked</strong> as a directory in the destination path; <code>URL</code> downloaded archive will NOT be auto decompressed</li> <li>if multiple source paths are specified, the destination path must be a directory and <strong>ends with a <em>backslash</em></strong></li> <li>destination path is an <strong>absolute path</strong> or <strong>relative path to <code>WORKDIR</code></strong> inside the image and will be created if not exist</li> </ul> <p>You can also pass a compressed archive through STDIN: (<code>docker build - &lt; archive.tar.gz</code>), the <code>Dockerfile</code> at the <em>root</em> of the archive and the rest of the archive will be used as the <strong>context</strong> of the build.</p> <h4 id=copy>COPY<a class=headerlink href=#copy title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>COPY <span class=o>[</span>--chown<span class=o>=</span>&lt;user&gt;:&lt;group&gt;<span class=o>]</span> &lt;src&gt;... &lt;dest&gt;
COPY <span class=o>[</span>--chown<span class=o>=</span>&lt;user&gt;:&lt;group&gt;<span class=o>]</span> <span class=o>[</span><span class=s2>&quot;&lt;src&gt;&quot;</span>,... <span class=s2>&quot;&lt;dest&gt;&quot;</span><span class=o>]</span>
</code></pre></div> </details> <p><strong><code>COPY</code></strong> instruction copies new <strong>files or directories</strong> from <code>&lt;src&gt;</code> and adds them to the filesystem of the container at the path <code>&lt;dest&gt;</code></p> <ul> <li>like <code>ADD</code> but work only for <strong>files and directories</strong></li> <li>optionally accepts a flag <code>--from=&lt;name|index&gt;</code> that can be used to set the <strong>source location</strong> to a previous <strong>build stage</strong> (created with <code>FROM .. AS &lt;name&gt;</code>) that will be used instead of a build <strong>context</strong> sent by the user</li> <li>the first encountered <code>COPY</code> instruction will <strong>invalidate the cache</strong> for all following instructions if the CONTENTS of one of its source paths have changed</li> <li><strong>Tip</strong><ul> <li>prefer <code>COPY</code> over <code>ADD</code> unless using the convenience provided by <code>ADD</code><ul> <li>use <code>curl</code> or <code>wget</code> to fetch files allows having the chance to discard unwanted files in the same instruction</li> </ul> </li> <li>if you have multiple <code>Dockerfile</code> steps that use different files from your context, <code>COPY</code> them <strong>individually</strong>, rather than all at once. This ensures that each step's build cache is only invalidated if the specifically required files change.</li> </ul> </li> </ul> <h4 id=entrypoint>ENTRYPOINT<a class=headerlink href=#entrypoint title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>ENTRYPOINT <span class=o>[</span><span class=s2>&quot;/script/start.sh&quot;</span><span class=o>]</span>
</code></pre></div> </details> <p><strong><code>ENTRYPOINT</code></strong> instruction configures how a container will run as an executable</p> <ul> <li>two forms<ul> <li><code>ENTRYPOINT ["executable", "param1", "param2"]</code> is called the <strong>exec form</strong></li> <li><code>ENTRYPOINT command param1 param2</code> is called the <strong>shell form</strong></li> </ul> </li> <li><em>command line arguments</em> to <code>docker run &lt;image&gt;</code> will be APPENDED after all elements in an <em>exec form</em> <code>ENTRYPOINT</code> and will <strong>override</strong> all elements specified using <code>CMD</code></li> <li>you can override the <code>ENTRYPOINT</code> instruction using the <code>docker run --entrypoint</code> flag</li> <li>shell form <strong>PREVENTS</strong> any <code>CMD</code> or <code>docker run</code> command line arguments from being used</li> <li>shell form will start the command with <code>/bin/sh -c</code> and has some disadvantages<ul> <li>executable will <strong>NOT</strong> be the container's <code>PID 1</code></li> <li>executable will <strong>NOT</strong> receive Unix signals and it will <strong>NOT</strong> receive <code>SIGTERM</code> signal from <code>docker stop &lt;container&gt;</code></li> <li>to fix the above two issues, make sure to start a command with <code>exec</code> which will invoke the command in another shell session, i.e. <code>ENTRYPOINT exec top -b</code></li> </ul> </li> <li>only the last <code>ENTRYPOINT</code> in the <code>Dockerfile</code> will be used, if multiple are provided</li> <li>if <code>CMD</code> is defined from the <em>base image</em>, setting <code>ENTRYPOINT</code> will RESET <code>CMD</code> to an empty value.</li> </ul> <h4 id=volume>VOLUME<a class=headerlink href=#volume title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>VOLUME <span class=o>[</span><span class=s2>&quot;/var/log/&quot;</span><span class=o>]</span>
VOLUME /var/log /var/db
</code></pre></div> </details> <p><strong><code>VOLUME</code></strong> instruction creates a <strong>mount point</strong> with the specified name and marks it as holding externally mounted volumes from native host or other containers.</p> <ul> <li>if any build steps change the data within the volume after it has been declared, those changes will be discarded</li> <li>the host directory (the <em>mountpoint</em>) is declared at container <strong>run-time</strong></li> <li>for portability, a given host directory can't be guaranteed to be available on all hosts, thus you can’t mount a host directory from within the Dockerfile</li> <li><code>VOLUME</code> does not support specifying a <em>host-dir</em> parameter. You must specify the <em>mountpoint</em> when you <strong>create</strong> or <strong>run</strong> the container</li> <li><strong>Tip</strong> <code>VOLUME</code> should be used to expose any database storage area, configuration storage, or files/folders created by your docker container.<ul> <li>You are strongly encouraged to use <code>VOLUME</code> for any <em>mutable</em> and/or <em>user-serviceable</em> parts of your image.</li> </ul> </li> </ul> <p>More on Docker volumes is <a href=https://docs.docker.com/storage/volumes/ >here</a></p> <h4 id=user>USER<a class=headerlink href=#user title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>USER &lt;user&gt;<span class=o>[</span>:&lt;group&gt;<span class=o>]</span>
USER &lt;UID&gt;<span class=o>[</span>:&lt;GID&gt;<span class=o>]</span>
</code></pre></div> </details> <p><strong><code>USER</code></strong> instruction sets the <code>user</code> name (or <code>UID</code>) and optionally the user <code>group</code> (or <code>GID</code>) to use when running the image and for any <code>RUN</code>, <code>CMD</code> and <code>ENTRYPOINT</code> instructions follows</p> <ul> <li>when specifying a group for the user, the user will have ONLY the specified group membership</li> <li>when the user doesn’t have a primary group then the image (or the next instructions) will be run with the root group</li> <li><strong>Tip</strong><ul> <li>if a service can run without privileges, use <code>USER</code> to change to a <strong>non-root</strong> user</li> <li>avoid installing or using <code>sudo</code> as it has unpredictable TTY and signal-forwarding behavior that can cause problems</li> <li>if you absolutely need functionality similar to <code>sudo</code>, such as initializing the daemon as root but running it as non-root, consider using <code>gosu</code></li> <li>avoid switching USER back and forth frequently</li> </ul> </li> </ul> <h4 id=workdir>WORKDIR<a class=headerlink href=#workdir title="Permanent link">&para;</a></h4> <p><strong><code>WORKDIR</code></strong> instruction sets the working directory for any <code>RUN</code>, <code>CMD</code>, <code>ENTRYPOINT</code>, <code>COPY</code> and <code>ADD</code> instructions follows</p> <ul> <li>if the <code>WORKDIR</code> doesn’t exist, it will be <strong>created</strong></li> <li>it can be used multiple times <code>WORKDIR /path/to/workdir</code></li> <li>it could be a relative path to previous <code>WORKDIR</code></li> <li>it can interpret variables set with <code>ENV</code></li> <li>without a <code>WORKDIR</code> instruction, the work directory in the image is the root</li> <li><strong>Tip</strong><ul> <li>always use absolute paths for <code>WORKDIR</code></li> <li>use <code>WORKDIR</code> instead of proliferating instructions like <code>RUN cd … &amp;&amp; do-something</code>, which are hard to read, troubleshoot, and maintain</li> </ul> </li> </ul> <h4 id=arg>ARG<a class=headerlink href=#arg title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>ARG <span class=nv>user1</span><span class=o>=</span>someuser
ARG <span class=si>${</span><span class=nv>user2</span><span class=k>:-</span><span class=nv>some_user</span><span class=si>}</span>
ARG buildno
</code></pre></div> </details> <p><strong><code>ARG</code></strong> instruction defines a variable that users can pass at <em>build-time</em> to the builder with the <code>docker build</code> command using the <code>--build-arg &lt;varname&gt;=&lt;value&gt;</code> flag</p> <ul> <li>a default value can be set with <code>ARG</code></li> <li>undefined variable results in empty string</li> <li>do not use it to pass secrets; build-time variables are visible in the image with <code>docker history</code> command<ul> <li>use <strong>BuildKit</strong> instead</li> </ul> </li> <li><code>ARG</code> instruction goes out of scope at the end of the build stage where it was defined<ul> <li>to use an arg in multiple stages, each stage must include the <code>ARG</code> instruction</li> </ul> </li> <li>variables defined using the <code>ENV</code> instruction always override an <code>ARG</code> instruction of the same name</li> <li>some special predefined <code>ARG</code> variables can be set and used without an <code>ARG</code> instruction: <code>HTTP_PROXY HTTPS_PROXY FTP_PROXY NO_PROXY</code> and their lowercase version<ul> <li>they won't be saved in <code>docker history</code> neither unless they are included with <code>ARG</code></li> </ul> </li> <li>some predefined platform <code>ARG</code> variables are set automatically: <code>TARGETPLATFORM TARGETOS TARGETARCH TARGETVARIANT BUILDPLATFORM BUILDOS BUILDARCH BUILDVARIANT</code><ul> <li>they are not automatically included so need to include an <code>ARG</code> instruction to make it available</li> </ul> </li> <li>if an <code>ARG</code> value is different from a previous build, then a "cache miss" occurs upon its first usage, not its definition</li> </ul> <h4 id=onbuild>ONBUILD<a class=headerlink href=#onbuild title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>ONBUILD ADD . /app/src
ONBUILD RUN /usr/local/bin/python-build --dir /app/src
</code></pre></div> </details> <p><strong><code>ONBUILD</code></strong> instruction adds to the image a <strong>trigger instruction</strong> to be executed at a later time, when the image is used as the <strong>base</strong> for another build</p> <ul> <li>it won't affect current build and can be viewed by <code>docker inspect &lt;image&gt;</code></li> <li>the trigger will be executed in the <strong>context of the downstream</strong> build; if all triggers succeed, the <code>FROM</code> instruction completes and the build continues</li> <li>any build instruction can be registered as a trigger; an image can have multiple <code>ONBUILD</code> instructions</li> <li>it will <strong>NOT</strong> be inherited to the downstream build</li> <li><strong>Tip</strong> images built with <code>ONBUILD</code> should get a separate tag, for example: <code>ruby:1.9-onbuild</code></li> </ul> <h4 id=stopsignal>STOPSIGNAL<a class=headerlink href=#stopsignal title="Permanent link">&para;</a></h4> <p><strong><code>STOPSIGNAL</code></strong> instruction sets the <strong>system call signal</strong> that will be sent to the container to exit</p> <ul> <li>can be a valid unsigned number that matches a position in the kernel's syscall table</li> </ul> <h4 id=healthcheck>HEALTHCHECK<a class=headerlink href=#healthcheck title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>HEALTHCHECK --interval<span class=o>=</span>5m --timeout<span class=o>=</span>3s <span class=se>\</span>
  CMD curl -f http://localhost/ <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span>
</code></pre></div> </details> <p><strong><code>HEALTHCHECK</code></strong> instruction tells Docker how to test a container to check that it is still working</p> <ul> <li>when a container has a healthcheck specified, it has a <em>health status</em> in addition to its normal status</li> <li>can only be one <code>HEALTHCHECK</code> instruction in a <code>Dockerfile</code></li> <li><code>HEALTHCHECK [OPTIONS] CMD command</code> and <em>OPTIONS</em> can be:<ul> <li><code>--interval=DURATION</code> default 30s, time between every other check</li> <li><code>--timeout=DURATION</code> default 30s, fails if a check takes longer than this timeout</li> <li><code>--start-period=DURATION</code> default 0s, initialization time before starting the check</li> <li><code>--retries=N</code> default 3</li> </ul> </li> <li>command could be a shell command or an exec JSON array</li> <li>any output from the check will be stored in the health status and visible in <code>docker inspect</code></li> </ul> <h4 id=shell>SHELL<a class=headerlink href=#shell title="Permanent link">&para;</a></h4> <details class=note open=open><summary>Code</summary><div class=highlight><pre><span></span><code>SHELL <span class=o>[</span><span class=s2>&quot;/bin/bash&quot;</span>, <span class=s2>&quot;-c&quot;</span><span class=o>]</span>
</code></pre></div> </details> <p><strong><code>SHELL</code></strong> instruction allows overriding the default shell used for the shell form of commands</p> <ul> <li>default shell on Linux is ["/bin/sh", "-c"]</li> <li>it must be written in <strong>exec JSON form</strong></li> <li>it can appear multiple times</li> <li>each <code>SHELL</code> instruction overrides all previous <code>SHELL</code> instructions, and affects all <strong>subsequent</strong> <code>RUN CMD ENTRYPOINT</code> instructions</li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../Docker/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> Docker and Containers </div> </div> </a> <a href=../../k8s/K8s-Knowledge/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> K8s Knowledge </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/vendor.53cc9318.min.js></script> <script src=../../../assets/javascripts/bundle.e9c9f54f.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../..",
          features: ['navigation.tabs', 'navigation.instant'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>